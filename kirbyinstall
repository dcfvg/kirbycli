#!/bin/bash
# kirby-install

destination=$1         # destination folder
user=$2                # root username
dirext=ext             # extension directory

echo "$precontent as $destination"
echo "user : $user"
echo "-"

git clone https://github.com/bastianallgeier/kirbycms.git $destination

cd $destination

rm *.mdown

# update .gitignore
# cp .gitignore .gitignore.bak
sed -i.bak "s/panel\///g" .gitignore
echo "/content" >> ".gitignore"
echo "/thumbs" >> ".gitignore"

# init panel
git submodule add https://github.com/bastianallgeier/kirbycms-panel.git panel
cp -r panel/defaults site/panel

# init main user
echo "set main user : $user"
sed "s/admin/$user/g" site/panel/accounts/admin.php > site/panel/accounts/$user.php
rm site/panel/accounts/admin.php

# init extension
git submodule add https://github.com/bastianallgeier/kirbycms-extensions.git $dirext

# add jquery
mkdir -vp "assets/js/"
wget http://code.jquery.com/jquery-2.1.1.min.js -O "assets/js/jquery.js"

# add bootstrap
mkdir -vp "assets/libraries/"
git submodule add https://github.com/twbs/bootstrap.git "assets/libraries/bootstrap/"

# install extentions
echo "copy fields, plugins and templates"
cp -vr $dirext/fields/* panel/fields
cp -vr $dirext/plugins/* site/plugins
cp -vr $dirext/templates/* site/templates

rm -vr site/plugins/email/
rm -vr site/plugins/sublimevideo/
rm -vr site/plugins/resrc/

# thumbs
echo "creating thumbs folder"
mkdir thumbs
chmod -R 747 thumbs

ls -la

git add -A && git commit -m "auto install with $precontent as $destination"
echo "ok !"