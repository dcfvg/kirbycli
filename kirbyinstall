#!/bin/bash
# kirby-install

destination=$1         # destination folder
user=$2                # root username
dirext=ext             # extension directory

echo "$precontent as $destination"
echo "user : $user"
echo "-"

git clone https://github.com/bastianallgeier/kirbycms.git $destination

cd $destination

rm *.mdown

# update .gitignore
cp .gitignore .gitignore.bak
sed -i "/panel/d" .gitignore  # remove /panel from .gitignore
echo "/content" >> .gitignore
echo "/thumbs" >> .gitignore

# init panel

git submodule add https://github.com/bastianallgeier/kirbycms-panel.git panel
cp -r panel/defaults site/panel

# init main user
echo "set main user : $user"
sed "s/admin/$user/g" site/panel/accounts/admin.php > site/panel/accounts/$user.php
rm site/panel/accounts/admin.php

# init extension
git submodule add https://github.com/bastianallgeier/kirbycms-extensions.git $dirext

# install extentions
echo "copy fields, plugins and templates"
cp -r $dirext/fields/* panel/fields
cp -r $dirext/plugins/* site/plugins
cp -r $dirext/templates/* site/templates

rm -r site/plugins/email/
rm -r site/plugins/sublimevideo/
rm -r site/plugins/resrc/

# thumbs
echo "creating thumbs folder"
mkdir thumbs
chmod -R 747 thumbs

ls -la

git add -A && git commit -m "auto install with $precontent as $destination"
echo "ok !"